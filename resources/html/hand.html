<html>
<head>
  <title>St. Abbey Cards</title>
  <script src="/resources/js/common.js"></script>
  <link rel="stylesheet/less" href="/resources/css/hand.less" />
  <!-- TODO should switch to compiled CSS for release -->
  <script src="/resources/js/libs/less.1.7.3.min.js" type="text/javascript">
  </script>
</head>
<body>
<div id="cards"></div>
<a id="start-link" href="javascript:st.startGame()">START GAME</a>
<script>
(function() {

  var BUTTON_PREFIX = '/resources/img/card/btn_';
  var PLAYER = {{.Me}};
  var containerDiv = st.getById('cards');
  var hand = [];
  var clientTick = 0;

  function CardButton(type, onClick) {
    if (!onClick) {
      this.root = st.createImg('', 'button', BUTTON_PREFIX + type +
          '_disable.png');
      return;
    }
    var pressed = false;
    var self = this;
    this.root = st.createImg('', 'button', BUTTON_PREFIX + type + '.png');
    this.root.onmousedown = function() {
      self.root.src = BUTTON_PREFIX + type + '_press.png';
      pressed = true;
    };
    this.root.onmouseout = function() {
      self.root.src = BUTTON_PREFIX + type + '.png';
      pressed = false;
    };
    this.root.onmouseup = function() {
      if (pressed) {
        pressed = false;
        self.root.onmouseout();
        onClick();
      }
    };
  };

  function Card(name, actions, image, count) {
    var self = this;
    this.root = st.createDiv('', 'card-wrapper');
    var container = st.createDiv('', 'card');
    this.root.appendChild(container);
    var artImg = st.createImg('', 'art', image);
    var maskImg = st.createImg('', 'mask', '/resources/img/card/card.png');
    var cardTitle = st.createDiv('', 'title');
    cardTitle.innerHTML = name;
    var cardCount = st.createDiv('', 'count');
    cardCount.innerHTML = count;
    container.appendChild(artImg);
    container.appendChild(maskImg);
    container.appendChild(cardTitle);
    container.appendChild(cardCount);
    this.buttons = [];
    this.buttons.push(new CardButton('up',
        actions & st.CardActions.UP ? this.clickUp : null));
    this.buttons.push(new CardButton('left',
        actions & st.CardActions.LEFT ? this.clickLeft : null));
    this.buttons.push(new CardButton('right',
        actions & st.CardActions.RIGHT ? this.clickRight : null));
    this.buttons.push(new CardButton('down',
        actions & st.CardActions.DOWN ? this.clickDown : null));
    this.buttons.push(new CardButton('self',
        actions & st.CardActions.SELF ? this.clickSelf : null));
    this.buttons.push(new CardButton('channel',
        actions & st.CardActions.CHANNEL ? this.clickChannel : null));
    for (var i = 0; i < this.buttons.length; i++) {
      var buttonRoot = this.buttons[i].root;
      buttonRoot.style.top = (178 + 147 * i) + 'px';
      container.appendChild(buttonRoot);
    }
    container.onclick = function() {
      if (hand[hand.length - 1] != self) {
        var before = [];
        for (var i = 0; hand[i] != self; i++) {
          before.push(hand[i]);
        }
        var after = [];
        for (i++; i < hand.length; i++) {
          after.push(hand[i]);
        }
        hand = before.concat(after);
        hand.push(self);
        arrangeHand();
      }
    };
  }
  Card.prototype.clickLeft = function() {};
  Card.prototype.clickDown = function() {};
  Card.prototype.clickUp = function() {};
  Card.prototype.clickRight = function() {};
  Card.prototype.clickSelf = function() {};
  Card.prototype.clickChannel = function() {};

  window.onresize = function() {
    containerDiv.style.zoom = window.innerWidth / 780.;
  };

  st.startGame = function() {
    window.onresize();
    st.removeElement(st.getById('start-link'));
    st.connection.sendStartGame();
    st.connection.sendTick(++clientTick);
  };

  function buildHand() {
    st.removeChildren(containerDiv);
    for (var i = 0; i < hand.length; i++) {
      containerDiv.appendChild(hand[i].root);
    }
    arrangeHand();
  }

  function arrangeHand() {
    for (var i = 0; i < hand.length; i++) {
      var style = hand[i].root.style;
      style.left = (4 * i) + 'px';
      style.top = (90 * i) + 'px';
      style.zIndex = i;
    }
  }

  function handleClientTick() {
  }

  function handleServerTick(serverState) {
    if (serverState.Players) {
      hand = [];
      var availableActions = serverState.Players[PLAYER].AvailableActions;
      for (var i = 0; i < availableActions.length; i++) {
        var action = availableActions[i];
        var dirs = st.CardActions.CHANNEL;
        if (action.AvailableDirections[0])
          dirs |= st.CardActions.LEFT;
        if (action.AvailableDirections[1])
          dirs |= st.CardActions.RIGHT;
        if (action.AvailableDirections[2])
          dirs |= st.CardActions.UP;
        if (action.AvailableDirections[3])
          dirs |= st.CardActions.DOWN;
        if (action.AvailableDirections[4])
          dirs |= st.CardActions.SELF;
        hand.push(new Card(action.ShortDescription, dirs,
            '/resources/img/card/card_art_001.png', '&infin;'));
      }
      buildHand();
    }
  }

  // Connect to the server via WebSocket.
  st.connection = new st.Connection("Hand", "{{.Host}}", PLAYER,
      handleClientTick, handleServerTick);

})();
</script>
</body>
</html>
<!-- vim: set ts=2 sw=2 sts=2: -->
